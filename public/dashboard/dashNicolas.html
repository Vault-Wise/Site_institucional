<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/index.ico" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | VaultWise</title>

    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/dashboardNicolas.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="carregar(), selecionarAgencia()">
    <div class="pagina">
        <nav>
            <ul id="listaNavegacao">
                <li>
                    <a href="#">
                        <div class="cargoUsuario">
                            <div class="usuario">
                                <img src="../css/imagens/icon12.jpg" alt="">
                                <span id="b_usuario">Usuário</span>
                            </div>
                            <div class="cargo">
                                <span id="cargo_usuario"></span>
                            </div>
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="content">
            <div class="conteudo-dash">
                <h1 class="titulo_dash">Ano -
                    <select type="text" id="select_ano" onchange="VisuAlertaHorario(), buscarAgencia()"></select>
                    | Agência <div id="agencia_top_alerta">0</div>
                </h1>
                <div class="kpis">
                    <div class="card">
                        <div class="cardParte1">
                            <span class="cardSpan">Agência com mais alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência<div id="maior_alerta" class="espacamento">x</div>
                                    <div class="conteudo_info">CEP: xxx Número: xxx</div>
                            </div>
                            </span>
                        </div>
                        <div class="borda"></div>
                        <div class="cardParte2">
                            <span class="cardSpan">Agência com menos alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência <div id="menos_alerta" class="espacamento">x
                                    </div>
                                    <div class="conteudo_info">CEP: xxx Número: xxx</div>
                            </div>
                            </span>
                        </div>
                    </div>
                    <div class="card2">
                        <div class="cardParte3">
                            <span class="cardSpan">Quantidade de alertas por horário</span>
                        </div>

                        <div class="cardParte4">
                            <div class="periodos">
                                <span class="cardSpan">Manhã</span>
                                <span class="cardSpanDestaque" id="qtd_manha">43 <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Tarde</span>
                                <span class="cardSpanDestaque" id="qtd_tarde">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Noite</span>
                                <span class="cardSpanDestaque" id="qtd_noite">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="graficos">
                    <div class="conteudo-grafico">
                        <div class="grafico">
                            <div class="selects">
                                <select type="text" id="select_componente">
                                    <option value="#" disabled selected>Selecionar componente</option>
                                    <option value="">CPU</option>
                                    <option value="">RAM</option>
                                </select>
                                <select type="text" id="select_agencia" onchange="VisuAlertaHorario()">

                                </select>
                            </div>
                            <div id="chart">
                                <h2 class="titulo_grafico">Desempenho Médio Anual de x - Agência 01 (2023-2024)</h2>
                            </div>
                        </div>
                        <button class="check" onclick="adicionarGrafico()" id="botaoPlus"><i
                                class="fa-solid fa-plus"></i></button>
                        <div id="bordaGrafico" style="display: none;"></div>
                        <div class="grafico2" style="display: none;" id="grafico2">
                            <div class="selects">
                                <select type="text" id="select_agencia2">
                                    <option value="" disabled selected>Selecionar agência</option>
                                </select>
                                <button class="check" onclick="fecharGrafico()"><i class="fa-solid fa-x"></i></button>
                            </div>
                            <div id="chart2">
                                <h2 class="titulo_grafico">Desempenho Médio Anual de x - Agência 01 (2023-2024)</h2>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</body>

</html>

<script>

    function carregar() {

        var options = {
            chart: {
                type: "bar",
            },
            series: [
                {
                    name: "2023",
                    data: [67, 68, 72, 71, 75, 60, 70, 67, 68, 72, 71, 75],
                },
                {
                    name: "2024",
                    data: [60, 67, 65, 62, 58, 55, 65, 60, 67, 65, 62],
                },
            ],
            xaxis: {
                categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
            },
            legend: {
                position: 'top',
            },
            dataLabels: {
                enabled: false
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val + "%";
                    }
                }
            }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        var options = {
            chart: {
                type: "bar",
            },
            series: [
                {
                    name: "2023",
                    data: [67, 68, 72, 71, 75, 60, 70, 67, 68, 72, 71, 75],
                },
                {
                    name: "2024",
                    data: [60, 67, 65, 62, 58, 55, 65, 60, 67, 65, 62],
                },
            ],
            xaxis: {
                categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
            },
            legend: {
                position: 'top',
            },
            dataLabels: {
                enabled: false
            },
            yaxis: {
                labels: {
                    formatter: function (val) {
                        return val + "%";
                    }
                }
            }
        };

        var chart2 = new ApexCharts(document.querySelector("#chart2"), options);
        chart2.render();
    }

    document.addEventListener("DOMContentLoaded", () => {
        validarSessao()

        const dashPedro = document.getElementById("dashPedro");
        const dashNicolas = document.getElementById("dashNicolas");

        if (dashPedro.classList.contains("agora")) {
            dashPedro.classList.remove("agora");
        }

        if (!dashNicolas.classList.contains("agora")) {
            dashNicolas.classList.add("agora")
        }
    });

    var adicionar = 1;

    function adicionarGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");

        if (adicionar == 1) {

            grafico2.style.display = 'flex';
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.1)';
            botaoPlus.style.display = 'none';

            bordaGrafico.style.display = 'flex';
            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.1)';


            setTimeout(() => {
                grafico2.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                grafico2.style.opacity = '1';
                grafico2.style.transform = 'scale(1)';

                bordaGrafico.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                bordaGrafico.style.opacity = '1';
                bordaGrafico.style.transform = 'scale(1)';
            }, 100);

            adicionar = 0;
        }
    }

    function fecharGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");

        if (adicionar === 0) {
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.9)';

            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.9)';

            setTimeout(() => {
                grafico2.style.display = 'none';
                botaoPlus.style.display = 'flex';
                bordaGrafico.style.display = 'none';


            }, 500);

            adicionar = 1;
        }

    }

    //KPI 1
    function buscarAgencia() {
        var agenciaTopAlertas = document.getElementById("agencia_top_alerta");
        var maisAlertas = document.getElementById("maior_alerta");
        var menosAlertas = document.getElementById("menos_alerta");
        var selectAgencia = document.getElementById("select_agencia");

        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;


                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function buscarAgenciaSelecionada() {
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        var selectAno = document.getElementById("select_ano");
        var anos = select_ano.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    const opcaoExistente = document.querySelector(`#select_agencia option[value="${agenciaMaisAlertas.fkAgencia}"]`);
                    if (opcaoExistente) {
                        opcaoExistente.selected = true;
                        opcaoExistente.disabled = true;
                    } else {
                        const option = document.createElement("option");
                        option.value = agenciaMaisAlertas.fkAgencia;
                        option.text = `Agência ${agenciaMaisAlertas.fkAgencia}`;
                        option.selected = true;
                        option.disabled = true;
                        selectAgencia.appendChild(option);
                    }
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }

                VisuAlertaHorario();
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    // SELECT DA TELA
    function selecionarAgencia() {
        fetch(`/agencia/listar`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {
                    
                    dados.agencias.forEach((agencia) => {
                        if (!document.querySelector(`#select_agencia option[value="${agencia.idAgencia}"]`)) {
                            select_agencia.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                            select_agencia2.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                        }
                    });

                    
                    dados.anos.forEach((ano) => {
                        if (!document.querySelector(`#select_ano option[value="${ano.anoAtual}"]`)) {
                            select_ano.innerHTML += `<option value="${ano.anoAtual}">${ano.anoAtual}</option>`;
                        }
                    });

                    buscarAgenciaSelecionada();
                    buscarAgencia();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    var agencias = select_agencia.value;

    //KPI 2
    function VisuAlertaHorario() {

        var agenciaTopAlertas = document.getElementById("agencia_top_alerta");
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;
        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        agenciaTopAlertas.innerHTML = agencias;

        var qtd_manha = document.getElementById("qtd_manha");
        var qtd_tarde = document.getElementById("qtd_tarde");
        var qtd_noite = document.getElementById("qtd_noite");

        console.log(agencias)
        // COLOCAR O RESULTADO NA KPI
        fetch(`/agencia/alertaHorario/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((agencia) => {
                    agencia.forEach((agencia) => {

                        if (agencia.manha == 1) {
                            qtd_manha.innerHTML = `${agencia.manha} alerta`
                        } else if (agencia.manha == 0) {
                            qtd_manha.innerHTML = `0 alertas`
                        } else {
                            qtd_manha.innerHTML = `${agencia.manha} alertas`
                        }

                        if (agencia.tarde == 1) {
                            qtd_tarde.innerHTML = `${agencia.tarde} alerta`
                        } else if (agencia.tarde == 0) {
                            qtd_tarde.innerHTML = `0 alertas`
                        } else {
                            qtd_tarde.innerHTML = `${agencia.tarde} alertas`
                        }

                        if (agencia.noite == 1) {
                            qtd_noite.innerHTML = `${agencia.noite} alerta`
                        } else if (agencia.noite == 0) {
                            qtd_noite.innerHTML = `0 alertas`
                        } else {
                            qtd_noite.innerHTML = `${agencia.noite} alertas`
                        }

                        var allOptions = select_agencia.querySelectorAll('option');
                        allOptions.forEach(option => {
                            if (option.value === agencias) {
                                option.disabled = true;
                            } else {
                                option.disabled = false;
                            }
                        });

                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    setInterval(buscarAgencia, 5000);

    function agenciaSelecionadaAtual() {

        //var maquina = select_maquina.value; ainda não
        var agencia = select_agencia.value;

        fetch("/agencia/buscarAgencia", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

    }


</script>