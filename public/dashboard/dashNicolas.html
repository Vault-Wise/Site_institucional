<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/index.ico" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | VaultWise</title>

    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/dashboardNicolas.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="selecionarAgencia()">
    <div class="pagina">
        <nav>
            <ul id="listaNavegacao">
                <li>
                    <a href="#">
                        <div class="cargoUsuario">
                            <div class="usuario">
                                <img src="../css/imagens/icon12.jpg" alt="">
                                <span id="b_usuario">Usuário</span>
                            </div>
                            <div class="cargo">
                                <span id="cargo_usuario"></span>
                            </div>
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="content">
            <div class="conteudo-dash">
                <h1 class="titulo_dash">Ano -
                    <select type="text" id="select_ano" onchange="VisuAlertaHorario(), buscarAgencia()"></select>
                </h1>
                <div class="kpis">
                    <div class="card">
                        <div class="cardParte1">
                            <span class="cardSpan">Agência com mais alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência<div id="maior_alerta" class="espacamento">x</div>
                                    <div class="conteudo_info">
                                        <p>CEP: <span id="cep_menos_alertas"></span></p>
                                        <p>Número: <span id="numero_menos_alertas"></span></p>
                                    </div>
                            </div>
                            </span>
                        </div>
                        <div class="borda"></div>
                        <div class="cardParte2">
                            <span class="cardSpan">Segunda agência com mais alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência <div id="menos_alerta" class="espacamento">x
                                    </div>
                                    <div class="conteudo_info">
                                        <p>CEP: <span id="cep_mais_alertas"></span></p>
                                        <p>Número: <span id="numero_mais_alertas"></span></p>
                                    </div>
                            </div>
                            </span>
                        </div>
                    </div>
                    <div class="card2">
                        <div class="cardParte3">
                            <span class="cardSpan">Quantidade de alertas por horário</span>
                        </div>

                        <div class="cardParte4">
                            <div class="periodos">
                                <span class="cardSpan">Madrugada</span>
                                <span class="cardSpanDestaque" id="qtd_madrugada">x <div class="espacamento">alertas
                                    </div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Manhã</span>
                                <span class="cardSpanDestaque" id="qtd_manha">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Tarde</span>
                                <span class="cardSpanDestaque" id="qtd_tarde">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Noite</span>
                                <span class="cardSpanDestaque" id="qtd_noite">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="graficos">
                    <div class="conteudo-grafico">
                        <div id="previsao" style="display: none;"></div>
                        <button class="check" onclick="adicionarPrevisao()" id="botaoPlusPrevisao">
                            <div class="botao_comparacao">
                                <span>Verificar Previsão</span>
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </div>
                        </button>
                        <div class="grafico">
                            <div class="selects">
                                <select class="select_estilo" type="text" id="select_agencia"
                                    onchange="VisuAlertaHorario(), dadosGrafico()"></select>
                                <select type="text" id="select_componente"
                                    onchange="dadosGrafico(), dadosGrafico2(), dadosGrafico3()">
                                    <option value="CPU">CPU</option>
                                    <option value="RAM">RAM</option>
                                </select>
                            </div>
                            <div id="chart">
                                <h2 class="titulo_grafico"></h2>
                            </div>
                        </div>
                        <div class="botoes_grafico">
                            <button class="check" onclick="adicionarGrafico()" id="botaoPlus">
                                <div class="botao_comparacao">
                                    <span>Criar Comparação</span>
                                    <i class="fa-solid fa-chart-simple"></i>
                                </div>
                            </button>
                            <button class="check" onclick="adicionarPix()" id="botaoPlusPix">
                                <div class="botao_comparacao">
                                    <span>Comparar com Pix</span>
                                    <i class="fa-solid fa-dollar-sign"></i>
                                </div>
                            </button>
                        </div>
                        <div id="bordaGrafico" style="display: none;"></div>
                        <div class="grafico2" style="display: none;" id="grafico2">
                            <div class="selects">
                                <select class="select_estilo" type="text" id="select_agencia2"
                                    onchange="dadosGrafico2()"></select>
                                <button class="check" onclick="fecharGrafico()"><i class="fa-solid fa-x"></i></button>
                            </div>
                            <div id="chart2">
                                <h2 class="titulo_grafico"></h2>
                            </div>
                        </div>
                        <div class="grafico3" style="display: none;" id="pix">
                            <div class="selects">
                                <select class="select_estilo" type="text" id="select_agencia3"
                                    onchange="dadosGrafico3()"></select>
                                <input id="arquivo_upload" type="file" onchange="dadosGrafico3()">
                                <div id="msg_erro_arquivo" style="display: none;"></div>
                                <button class="check" onclick="fecharPix()"><i class="fa-solid fa-x"></i></button>
                            </div>
                            <div id="chart3">
                                <h2 class="titulo_grafico"></h2>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</body>

</html>

<script>

    function carregar() {

    }

    document.addEventListener("DOMContentLoaded", () => {
        validarSessao()

        const dashPedro = document.getElementById("dashPedro");
        const dashNicolas = document.getElementById("dashNicolas");

        if (dashPedro.classList.contains("agora")) {
            dashPedro.classList.remove("agora");
        }

        if (!dashNicolas.classList.contains("agora")) {
            dashNicolas.classList.add("agora")
        }
    });

    var adicionar = 1;

    function adicionarGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");
        var botaoPlusPrevisao = document.getElementById("botaoPlusPrevisao");
        var botaoPlusPix = document.getElementById("botaoPlusPix");

        if (adicionar == 1) {

            grafico2.style.display = 'flex';
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.1)';
            botaoPlus.style.display = 'none';
            botaoPlusPrevisao.style.display = 'none';
            botaoPlusPix.style.display = 'none';

            bordaGrafico.style.display = 'flex';
            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.1)';


            setTimeout(() => {
                grafico2.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                grafico2.style.opacity = '1';
                grafico2.style.transform = 'scale(1)';

                bordaGrafico.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                bordaGrafico.style.opacity = '1';
                bordaGrafico.style.transform = 'scale(1)';
            }, 100);

            adicionar = 0;
        }
    }

    function fecharGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");
        var botaoPlusPix = document.getElementById("botaoPlusPix");

        if (adicionar === 0) {
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.9)';

            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.9)';

            setTimeout(() => {
                grafico2.style.display = 'none';
                botaoPlus.style.display = 'flex';
                botaoPlusPrevisao.style.display = 'flex';
                botaoPlusPix.style.display = 'flex';
                bordaGrafico.style.display = 'none';


            }, 500);

            adicionar = 1;
        }

    }

    var adicionar_Pix = 1;

    function adicionarPix() {

        var pix = document.getElementById("pix");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");
        var botaoPlusPrevisao = document.getElementById("botaoPlusPrevisao");
        var botaoPlusPix = document.getElementById("botaoPlusPix");

        if (adicionar_Pix == 1) {

            pix.style.display = 'flex';
            pix.style.opacity = '0';
            pix.style.transform = 'scale(0.1)';
            botaoPlus.style.display = 'none';
            botaoPlusPrevisao.style.display = 'none';
            botaoPlusPix.style.display = 'none';

            bordaGrafico.style.display = 'flex';
            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.1)';


            setTimeout(() => {
                pix.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                pix.style.opacity = '1';
                pix.style.transform = 'scale(1)';

                bordaGrafico.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                bordaGrafico.style.opacity = '1';
                bordaGrafico.style.transform = 'scale(1)';
            }, 100);

            adicionar_Pix = 0;
        }
    }

    function fecharPix() {

        var pix = document.getElementById("pix");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");
        var botaoPlusPix = document.getElementById("botaoPlusPix");

        if (adicionar_Pix === 0) {
            pix.style.opacity = '0';
            pix.style.transform = 'scale(0.9)';

            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.9)';

            setTimeout(() => {
                pix.style.display = 'none';
                botaoPlus.style.display = 'flex';
                botaoPlusPrevisao.style.display = 'flex';
                botaoPlusPix.style.display = 'flex';
                bordaGrafico.style.display = 'none';


            }, 500);

            adicionar_Pix = 1;
        }

    }

    var verificar = 1;

    function adicionarPrevisao() {

        var previsao = document.getElementById("previsao");
        var botaoPlusPrevisao = document.getElementById("botaoPlusPrevisao");

        if (verificar == 1) {

            previsao.style.display = 'block';
            previsao.style.opacity = '0';
            previsao.style.transform = 'scale(0.1)';
            previsao.style.position = `absolute`;
            previsao.style.top = `58%`;
            previsao.style.left = `18.5%`;

            botaoPlusPrevisao.innerHTML = `<span>Fechar Previsão</span> <i class="fa-solid fa-magnifying-glass"></i></i>`

            setTimeout(() => {
                previsao.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                previsao.style.opacity = '1';
                previsao.style.transform = 'scale(1)';
            }, 100);

            verificar = 0;
        } else {
            fecharPrevisao();
            botaoPlusPrevisao.innerHTML = `<span>Verificar Previsão</span> <i class="fa-solid fa-magnifying-glass"></i></i>`
            verificar = 1
        }
    }

    function fecharPrevisao() {

        var previsao = document.getElementById("previsao");
        var botaoPlusPrevisao = document.getElementById("botaoPlusPrevisao");

        if (verificar === 0) {
            previsao.style.opacity = '0';
            previsao.style.transform = 'scale(0.9)';

            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.9)';

            setTimeout(() => {
                previsao.style.display = 'none';
                botaoPlusPrevisao.style.display = 'block';

            }, 500);

            verificar = 1;
        }

    }

    let chart;

    function dadosGrafico() {
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        var select_componente = document.getElementById("select_componente")
        var componente = select_componente.value;

        var previsaoElemento = document.getElementById("previsao");

        console.log(agencias)

        fetch(`/agencia/dados/${agencias}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    var arrayDados2023CPU = [];
                    var arrayDados2024CPU = [];
                    var arrayDados2023RAM = [];
                    var arrayDados2024RAM = [];

                    dados.agencias.forEach((agencia) => {

                        if (agencia.ano == 2023) {
                            arrayDados2023RAM.push(agencia.MediaRAM);
                            arrayDados2023CPU.push(agencia.MediaCPU);

                        } else if (agencia.ano == 2024) {

                            arrayDados2024RAM.push(agencia.MediaRAM);
                            arrayDados2024CPU.push(agencia.MediaCPU);
                        }
                    });
                    console.log(arrayDados2024RAM.length)

                    var meses = [
                        "janeiro", "fevereiro", "março", "abril", "maio", "junho",
                        "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
                    ];

                    if (componente == "CPU") {
                        var soma24 = 0;
                        var soma23 = 0;

                        for (var i = 0; i < arrayDados2024CPU.length; i++) {
                            soma24 += Number(arrayDados2024CPU[i]);
                            soma23 += Number(arrayDados2023CPU[i]);

                        }
                        var previsao24 = soma24 / arrayDados2024CPU.length;
                        var media23 = soma23 / arrayDados2024CPU.length;

                        var ultimo_mes_previsto = arrayDados2023CPU[arrayDados2023CPU.length - 1];
                        console.log("Dezembro 2023 " + ultimo_mes_previsto)
                        console.log("Média de 2023: " + media23.toFixed(2))
                        console.log("Diferença da Média e Dezembro: " + (ultimo_mes_previsto - media23.toFixed(2)))

                        var diferenca = ultimo_mes_previsto - media23.toFixed(2);

                        var num_previsao = Number(previsao24.toFixed(2)) + Number(diferenca.toFixed(2));

                        var proximoMesIndex = arrayDados2024CPU.length;
                        var proximoMes = meses[proximoMesIndex] || `janeiro de 2025`;
                        previsaoElemento.innerHTML = `Previsão de ${componente} em ${proximoMes} é de aproximadamente: <b>${num_previsao.toFixed(2)}%</b>`

                    } else if (componente == "RAM") {
                        var soma24 = 0;
                        var soma23 = 0;

                        for (var i = 0; i < arrayDados2024RAM.length; i++) {
                            soma24 += Number(arrayDados2024RAM[i]);
                            soma23 += Number(arrayDados2023RAM[i]);

                        }
                        var previsao24 = soma24 / arrayDados2024RAM.length;
                        var media23 = soma23 / arrayDados2024RAM.length;

                        var ultimo_mes_previsto = arrayDados2023RAM[arrayDados2023RAM.length - 1];
                        console.log("Dezembro 2023 " + ultimo_mes_previsto)
                        console.log("Média de 2023: " + media23)
                        console.log("Diferença da Média e Dezembro: " + (ultimo_mes_previsto - media23.toFixed(2)))

                        var diferenca = ultimo_mes_previsto - media23.toFixed(2);

                        var num_previsao = Number(previsao24.toFixed(2)) + Number(diferenca.toFixed(2));

                        var proximoMesIndex = arrayDados2024CPU.length;
                        var proximoMes = meses[proximoMesIndex] || `janeiro de 2025`;
                        previsaoElemento.innerHTML = `Previsão de ${componente} em ${proximoMes} é de aproximadamente: <b>${num_previsao.toFixed(2)}%</b>`

                    }


                    var serieData = [];

                    if (componente == "CPU") {
                        serieData = [
                            { name: "2023", data: arrayDados2023CPU },
                            { name: "2024", data: arrayDados2024CPU }
                        ];
                    } else if (componente == "RAM") {
                        serieData = [
                            { name: "2023", data: arrayDados2023RAM },
                            { name: "2024", data: arrayDados2024RAM }
                        ];
                    }
                    console.log(arrayDados2024CPU)

                    if (chart) {
                        chart.destroy();
                    }

                    var options = {
                        chart: {
                            type: "bar",
                            animations: {
                                enabled: false
                            }
                        },
                        series: serieData,
                        xaxis: {
                            categories: meses,
                        },
                        legend: {
                            position: 'top',
                        },
                        dataLabels: {
                            enabled: false
                        },
                        yaxis: {
                            labels: {
                                formatter: function (val) {
                                    return val + "%";
                                }
                            },
                            min: 0,
                            max: 100
                        },
                        colors: [
                            "#247497",
                            "#0f1023"
                        ],
                        title: {
                            text: `Média de ${componente} por mês da Agência ${agencias}`,
                            style: {
                                fontSize: '20px',
                                fontWeight: 'normal',
                                fontFamily: "Poppins",
                                color: '#000',
                            },
                            align: 'center',
                            marginTop: 10,
                            marginBottom: 10,
                            paddingTop: 10,
                        }
                    };

                    chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    let chart2;

    function dadosGrafico2() {
        var select_agencia = document.getElementById("select_agencia");
        var agencias = select_agencia.value;

        var select_agencia2 = document.getElementById("select_agencia2");
        var agencias2 = select_agencia2.value;

        var select_componente = document.getElementById("select_componente");
        var componente = select_componente.value;

        fetch(`/agencia/dados/${agencias2}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    var arrayDados2023CPU = [];
                    var arrayDados2024CPU = [];
                    var arrayDados2023RAM = [];
                    var arrayDados2024RAM = [];

                    dados.agencias.forEach((agencia) => {
                        if (agencia.ano == 2023) {
                            arrayDados2023RAM.push(agencia.MediaRAM);
                            arrayDados2023CPU.push(agencia.MediaCPU);
                        } else if (agencia.ano == 2024) {
                            arrayDados2024RAM.push(agencia.MediaRAM);
                            arrayDados2024CPU.push(agencia.MediaCPU);
                        }
                    });

                    var serieData = [];
                    if (componente == "CPU") {
                        serieData = [
                            { name: "2023", data: arrayDados2023CPU },
                            { name: "2024", data: arrayDados2024CPU }
                        ];
                    } else if (componente == "RAM") {
                        serieData = [
                            { name: "2023", data: arrayDados2023RAM },
                            { name: "2024", data: arrayDados2024RAM }
                        ];
                    }

                    if (chart2) {
                        chart2.destroy();
                    }

                    var options2 = {
                        chart: {
                            type: "bar",
                            animations: {
                                enabled: false
                            }
                        },
                        series: serieData,
                        xaxis: {
                            categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
                        },
                        legend: {
                            position: 'top',
                        },
                        dataLabels: {
                            enabled: false
                        },
                        yaxis: {
                            labels: {
                                formatter: function (val) {
                                    return val + "%";
                                }
                            },
                            min: 0,
                            max: 100
                        },
                        colors: [
                            "#247497",
                            "#0f1023"
                        ],
                        title: {
                            text: `Média de ${componente} por mês da Agência ${agencias2}`,
                            style: {
                                fontSize: '20px',
                                fontWeight: 'normal',
                                fontFamily: "Poppins",
                                color: '#000',
                            },
                            align: 'center',
                            marginTop: 10,
                            marginBottom: 10,
                            paddingTop: 10,
                        }
                    };

                    chart2 = new ApexCharts(document.querySelector("#chart2"), options2);
                    chart2.render();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    let chart3;

    function dadosGrafico3() {
        var select_agencia = document.getElementById("select_agencia");
        var agencias = select_agencia.value;

        var select_agencia2 = document.getElementById("select_agencia2");
        var agencias2 = select_agencia2.value;

        var select_agencia3 = document.getElementById("select_agencia3");
        var agencias3 = select_agencia3.value;

        var select_componente = document.getElementById("select_componente");
        var componente = select_componente.value;

        var arquivoInput = document.getElementById('arquivo_upload');
        var msgErroArquivo = document.getElementById('msg_erro_arquivo');
        var arquivo = arquivoInput.files[0];

        fetch(`/agencia/dados/${agencias3}`, { method: "GET" })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((dados) => {
                var arrayDados2024CPU = [];
                var arrayDados2024RAM = [];
                var agrupamentoPorData = {};
                var arrayTransacoes2024 = [];

                const processarCSV = () => {
                    return new Promise((resolve, reject) => {
                        if (arquivo && arquivo.type === 'text/csv') {
                            var reader = new FileReader();

                            reader.onload = function (e) {
                                var content = e.target.result;
                                var rows = content.split('\n').filter(row => row.trim() !== '');
                                var data = rows.map(row => row.split(','));

                                data.forEach((row, rowIndex) => {
                                    if (rowIndex === 0) return; // Ignorar cabeçalho

                                    var dataTransacao = row[0]?.trim();
                                    var quantidadeTransacao = parseFloat(row[6]);

                                    if (isNaN(quantidadeTransacao)) {
                                        console.warn(`Valor inválido na linha ${rowIndex}:`, row[6]);
                                        return;
                                    }

                                    if (!agrupamentoPorData[dataTransacao]) {
                                        agrupamentoPorData[dataTransacao] = 0;
                                    }

                                    agrupamentoPorData[dataTransacao] += quantidadeTransacao;
                                });

                                for (const valor of Object.values(agrupamentoPorData)) {
                                    arrayTransacoes2024.push(valor / 1000);
                                }
                                resolve();
                            };

                            reader.onerror = reject;
                            reader.readAsText(arquivo);
                        } else {
                            msgErroArquivo.innerHTML = `Selecione apenas arquivos em CSV`;
                            resolve(); // Resolver mesmo sem arquivo para não travar a lógica
                        }
                    });
                };

                processarCSV().then(() => {
                    dados.agencias.forEach((agencia) => {
                        if (agencia.ano == 2024) {
                            arrayDados2024RAM.push(agencia.MediaRAM);
                            arrayDados2024CPU.push(agencia.MediaCPU);
                        }
                    });

                    var serieData = [];
                    if (componente === "CPU") {
                        serieData = [
                            { name: "2024 - CPU", data: arrayDados2024CPU },
                            { name: "2024 - Transações", data: arrayTransacoes2024, type: 'line' }
                        ];
                    } else if (componente === "RAM") {
                        serieData = [
                            { name: "2024 - RAM", data: arrayDados2024RAM },
                            { name: "2024 - Transações", data: arrayTransacoes2024, type: 'line' }
                        ];
                    }

                    if (chart3) {
                        chart3.destroy();
                    }

                    var options3 = {
                        chart: {
                            type: "line",
                            animations: {
                                enabled: false
                            },
                            toolbar: {
                                tools: {
                                    download: true,
                                    selection: false,
                                    zoom: false,
                                    zoomin: false,
                                    zoomout: false,
                                    pan: false,
                                    reset: false
                                }
                            }
                        },
                        series: serieData,
                        xaxis: {
                            categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
                        },
                        yaxis: [{
                            title: {
                                text: 'Uso (%)'
                            },
                            labels: {
                                formatter: function (val) {
                                    return val + "%";
                                }
                            },
                            min: 0,
                            max: 100
                        },
                        {
                        opposite: true,
                        title: {
                            text: 'Transações (milhares)'
                        },
                        labels: {
                            formatter: function (val) {
                                return val;
                            }
                        }
                        }],
                        legend: {
                            position: 'top',
                        },
                        dataLabels: {
                            enabled: false
                        },
                        colors: [
                            "#0f1023",
                            "#d86b22"
                        ],
                        title: {
                            text: `Média de ${componente} por mês da Agência ${agencias2}`,
                            style: {
                                fontSize: '20px',
                                fontWeight: 'normal',
                                fontFamily: "Poppins",
                                color: '#000',
                            },
                            align: 'center',
                            marginTop: 10,
                            marginBottom: 10,
                            paddingTop: 10,
                        }
                    };

                    chart3 = new ApexCharts(document.querySelector("#chart3"), options3);
                    chart3.render();
                });
            })
            .catch(function (resposta) {
                console.error(`#ERRO: ${resposta}`);
            });
    }



    //KPI 1
    function buscarAgencia() {
        var maisAlertas = document.getElementById("maior_alerta");
        var menosAlertas = document.getElementById("menos_alerta");
        var selectAgencia = document.getElementById("select_agencia");

        var cepMaisAlertas = document.getElementById("cep_mais_alertas");
        var cepMenosAlertas = document.getElementById("cep_menos_alertas");

        var numeroMaisAlertas = document.getElementById("numero_mais_alertas");
        var numeroMenosAlertas = document.getElementById("numero_menos_alertas");

        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    cepMaisAlertas.innerHTML = `${agenciaMaisAlertas.cep}`;
                    numeroMaisAlertas.innerHTML = `${agenciaMaisAlertas.numero}`;

                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;
                    cepMenosAlertas.innerHTML = `${agenciaMenosAlertas.cep}`;
                    numeroMenosAlertas.innerHTML = `${agenciaMenosAlertas.numero}`;

                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function buscarAgenciaSelecionada() {
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        var selectAno = document.getElementById("select_ano");
        var anos = select_ano.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    const opcaoExistente = document.querySelector(`#select_agencia option[value="${agenciaMaisAlertas.fkAgencia}"]`);
                    if (opcaoExistente) {
                        opcaoExistente.selected = true;
                        opcaoExistente.disabled = true;
                    } else {
                        const option = document.createElement("option");
                        option.value = agenciaMaisAlertas.fkAgencia;
                        option.text = `Agência ${agenciaMaisAlertas.fkAgencia}`;
                        option.selected = true;
                        option.disabled = true;
                        selectAgencia.appendChild(option);
                    }
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }

                dadosGrafico();
                dadosGrafico2();
                VisuAlertaHorario();

            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    // SELECT DA TELA
    function selecionarAgencia() {
        fetch(`/agencia/listar`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    dados.agencias.forEach((agencia) => {
                        if (!document.querySelector(`#select_agencia option[value="${agencia.idAgencia}"]`)) {
                            select_agencia.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                            select_agencia2.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                            select_agencia3.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                        }
                    });


                    dados.anos.forEach((ano) => {
                        if (!document.querySelector(`#select_ano option[value="${ano.anoAtual}"]`)) {
                            select_ano.innerHTML += `<option value="${ano.anoAtual}">${ano.anoAtual}</option>`;
                        }
                    });

                    buscarAgenciaSelecionada();
                    buscarAgencia();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    var agencias = select_agencia.value;

    //KPI 2
    function VisuAlertaHorario() {

        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;
        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        var qtd_manha = document.getElementById("qtd_manha");
        var qtd_tarde = document.getElementById("qtd_tarde");
        var qtd_noite = document.getElementById("qtd_noite");
        var qtd_madrugada = document.getElementById("qtd_madrugada");

        // COLOCAR O RESULTADO NA KPI
        fetch(`/agencia/alertaHorario/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((agencia) => {
                    agencia.forEach((agencia) => {

                        if (agencia.manha == 1) {
                            qtd_manha.innerHTML = `${agencia.manha} alerta`
                        } else if (agencia.manha == 0) {
                            qtd_manha.innerHTML = `0 alertas`
                        } else {
                            qtd_manha.innerHTML = `${agencia.manha} alertas`
                        }

                        if (agencia.tarde == 1) {
                            qtd_tarde.innerHTML = `${agencia.tarde} alerta`
                        } else if (agencia.tarde == 0) {
                            qtd_tarde.innerHTML = `0 alertas`
                        } else {
                            qtd_tarde.innerHTML = `${agencia.tarde} alertas`
                        }

                        if (agencia.noite == 1) {
                            qtd_noite.innerHTML = `${agencia.noite} alerta`
                        } else if (agencia.noite == 0) {
                            qtd_noite.innerHTML = `0 alertas`
                        } else {
                            qtd_noite.innerHTML = `${agencia.noite} alertas`
                        }

                        if (agencia.madrugada == 1) {
                            qtd_madrugada.innerHTML = `${agencia.noite} alerta`
                        } else if (agencia.madrugada == 0) {
                            qtd_madrugada.innerHTML = `0 alertas`
                        } else {
                            qtd_madrugada.innerHTML = `${agencia.noite} alertas`
                        }

                        var allOptions = select_agencia.querySelectorAll('option');
                        allOptions.forEach(option => {
                            if (option.value === agencias) {
                                option.disabled = true;
                            } else {
                                option.disabled = false;
                            }
                        });

                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    setInterval(buscarAgencia, 5000);
    setInterval(VisuAlertaHorario, 5000);
    setInterval(dadosGrafico, 5000);
    setInterval(dadosGrafico2, 5000);
    setInterval(dadosGrafico3, 5000);


    function agenciaSelecionadaAtual() {

        //var maquina = select_maquina.value; ainda não
        var agencia = select_agencia.value;

        fetch("/agencia/buscarAgencia", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

    }

    // function processarArquivoCSV() {
    //     var arquivoInput = document.getElementById('arquivo_upload');
    //     var msgErroArquivo = document.getElementById('msg_erro_arquivo');

    //     var arquivo = arquivoInput.files[0];

    //     if (arquivo && arquivo.type == 'text/csv') {
    //         var reader = new FileReader();

    //         reader.onload = function (e) {
    //             var content = e.target.result;
    //             var rows = content.split('\n');
    //             var data = rows.map(row => row.split(','));

    //             var agrupamentoPorData = {};

    //             data.forEach((row, rowIndex) => {
    //                 if (rowIndex === 0) return;

    //                 var dataTransacao = row[0];
    //                 var quantidadeTransacao = parseFloat(row[6]);

    //                 if (!agrupamentoPorData[dataTransacao]) {
    //                     agrupamentoPorData[dataTransacao] = 0;
    //                 }

    //                 agrupamentoPorData[dataTransacao] += quantidadeTransacao;
    //             });

    //             console.log(agrupamentoPorData);
    //         };

    //         reader.readAsText(arquivo);
    //     } else {
    //         msgErroArquivo.innerHTML = `Selecione apenas arquivos em CSV`;
    //     }
    // }


</script>