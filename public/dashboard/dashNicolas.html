<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/index.ico" type="image/x-icon" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | VaultWise</title>

    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/dashboardNicolas.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="selecionarAgencia()">
    <div class="pagina">
        <nav>
            <ul id="listaNavegacao">
                <li>
                    <a href="#">
                        <div class="cargoUsuario">
                            <div class="usuario">
                                <img src="../css/imagens/icon12.jpg" alt="">
                                <span id="b_usuario">Usuário</span>
                            </div>
                            <div class="cargo">
                                <span id="cargo_usuario"></span>
                            </div>
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="content">
            <div class="conteudo-dash">
                <h1 class="titulo_dash">Ano -
                    <select type="text" id="select_ano" onchange="VisuAlertaHorario(), buscarAgencia()"></select>
                </h1>
                <div class="kpis">
                    <div class="card">
                        <div class="cardParte1">
                            <span class="cardSpan">Agência com mais alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência<div id="maior_alerta" class="espacamento">x</div>
                                    <div class="conteudo_info">
                                        <p>CEP: <span id="cep_menos_alertas"></span></p>
                                        <p>Número: <span id="numero_menos_alertas"></span></p>  
                                    </div>
                            </div>
                            </span>
                        </div>
                        <div class="borda"></div>
                        <div class="cardParte2">
                            <span class="cardSpan">Segunda agência com mais alertas</span>
                            <div class="info-container">
                                <span class="cardSpanDestaque">Agência <div id="menos_alerta" class="espacamento">x
                                    </div>
                                    <div class="conteudo_info">
                                        <p>CEP: <span id="cep_mais_alertas"></span></p>
                                        <p>Número: <span id="numero_mais_alertas"></span></p>  
                                    </div>
                            </div>
                            </span>
                        </div>
                    </div>
                    <div class="card2">
                        <div class="cardParte3">
                            <span class="cardSpan">Quantidade de alertas por horário</span>
                        </div>

                        <div class="cardParte4">
                            <div class="periodos">
                                <span class="cardSpan">Manhã</span>
                                <span class="cardSpanDestaque" id="qtd_manha">43 <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Tarde</span>
                                <span class="cardSpanDestaque" id="qtd_tarde">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                            <div class="borda"></div>
                            <div class="periodos">
                                <span class="cardSpan">Noite</span>
                                <span class="cardSpanDestaque" id="qtd_noite">x <div class="espacamento">alertas</div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="graficos">
                    <div class="conteudo-grafico">
                        <div class="grafico">
                            <div class="selects">
                                <select class="select_estilo" type="text" id="select_agencia" onchange="VisuAlertaHorario(), dadosGrafico()"></select>
                                <select type="text" id="select_componente" onchange="dadosGrafico(), dadosGrafico2()">
                                    <option value="CPU">CPU</option>
                                    <option value="RAM">RAM</option>
                                </select>
                            </div>
                            <div id="chart">
                                <h2 class="titulo_grafico"></h2>
                            </div>
                        </div>
                        <button class="check" onclick="adicionarGrafico()" id="botaoPlus">
                            <div class="botao_comparacao">
                                <span>Criar Comparação</span>
                                <i class="fa-solid fa-chart-simple"></i>
                            </div>
                        </button>
                        <div id="bordaGrafico" style="display: none;"></div>
                        <div class="grafico2" style="display: none;" id="grafico2">
                            <div class="selects">
                                <select class="select_estilo" type="text" id="select_agencia2" onchange="dadosGrafico2()"></select>
                                <button class="check" onclick="fecharGrafico()"><i class="fa-solid fa-x"></i></button>
                            </div>
                            <div id="chart2">
                                <h2 class="titulo_grafico"></h2>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</body>

</html>

<script>

    function carregar() {

    }

    document.addEventListener("DOMContentLoaded", () => {
        validarSessao()

        const dashPedro = document.getElementById("dashPedro");
        const dashNicolas = document.getElementById("dashNicolas");

        if (dashPedro.classList.contains("agora")) {
            dashPedro.classList.remove("agora");
        }

        if (!dashNicolas.classList.contains("agora")) {
            dashNicolas.classList.add("agora")
        }
    });

    var adicionar = 1;

    function adicionarGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");

        if (adicionar == 1) {

            grafico2.style.display = 'flex';
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.1)';
            botaoPlus.style.display = 'none';

            bordaGrafico.style.display = 'flex';
            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.1)';


            setTimeout(() => {
                grafico2.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                grafico2.style.opacity = '1';
                grafico2.style.transform = 'scale(1)';

                bordaGrafico.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                bordaGrafico.style.opacity = '1';
                bordaGrafico.style.transform = 'scale(1)';
            }, 100);

            adicionar = 0;
        }
    }

    function fecharGrafico() {

        var grafico2 = document.getElementById("grafico2");
        var botaoPlus = document.getElementById("botaoPlus");
        var bordaGrafico = document.getElementById("bordaGrafico");

        if (adicionar === 0) {
            grafico2.style.opacity = '0';
            grafico2.style.transform = 'scale(0.9)';

            bordaGrafico.style.opacity = '0';
            bordaGrafico.style.transform = 'scale(0.9)';

            setTimeout(() => {
                grafico2.style.display = 'none';
                botaoPlus.style.display = 'flex';
                bordaGrafico.style.display = 'none';


            }, 500);

            adicionar = 1;
        }

    }

    let chart;

    function dadosGrafico() {
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        var select_componente = document.getElementById("select_componente")
        var componente = select_componente.value;

        console.log(agencias)

        fetch(`/agencia/dados/${agencias}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    var arrayDados2023CPU = [];
                    var arrayDados2024CPU = [];
                    var arrayDados2023RAM = [];
                    var arrayDados2024RAM = [];

                    dados.agencias.forEach((agencia) => {

                        if (agencia.ano == 2023) {

                            arrayDados2023RAM.push(agencia.MediaRAM);
                            arrayDados2023CPU.push(agencia.MediaCPU);
                        } else if (agencia.ano == 2024) {

                            arrayDados2024RAM.push(agencia.MediaRAM);
                            arrayDados2024CPU.push(agencia.MediaCPU);
                        }
                    });

                    var serieData = [];

                    if (componente == "CPU") {
                        serieData = [
                            { name: "2023", data: arrayDados2023CPU },
                            { name: "2024", data: arrayDados2024CPU }
                        ];
                    } else if (componente == "RAM") {
                        serieData = [
                            { name: "2023", data: arrayDados2023RAM },
                            { name: "2024", data: arrayDados2024RAM }
                        ];
                    }

                    if (chart) {
                        chart.destroy();
                    }

                    var options = {
                        chart: {
                            type: "bar",
                        },
                        series: serieData,
                        xaxis: {
                            categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
                        },
                        legend: {
                            position: 'top',
                        },
                        dataLabels: {
                            enabled: false
                        },
                        yaxis: {
                            labels: {
                                formatter: function (val) {
                                    return val + "%";
                                }
                            }
                        },
                        colors: [
                            "#247497",
                            "#0f1023"
                        ],
                        title: {
                            text: `Média de ${componente} por mês da Agência ${agencias}`,
                            style: {
                                fontSize: '20px',
                                fontWeight: 'normal',
                                fontFamily: "Poppins",
                                color: '#000',
                            },
                            align: 'center',
                            marginTop: 10,
                            marginBottom: 10,
                            paddingTop: 10,
                        }
                    };

                    chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    let chart2;

    function dadosGrafico2() {
        var select_agencia = document.getElementById("select_agencia");
        var agencias = select_agencia.value;

        var select_agencia2 = document.getElementById("select_agencia2");
        var agencias2 = select_agencia2.value;

        var select_componente = document.getElementById("select_componente");
        var componente = select_componente.value;

        fetch(`/agencia/dados/${agencias2}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    var arrayDados2023CPU = [];
                    var arrayDados2024CPU = [];
                    var arrayDados2023RAM = [];
                    var arrayDados2024RAM = [];

                    dados.agencias.forEach((agencia) => {
                        if (agencia.ano == 2023) {
                            arrayDados2023RAM.push(agencia.MediaRAM);
                            arrayDados2023CPU.push(agencia.MediaCPU);
                        } else if (agencia.ano == 2024) {
                            arrayDados2024RAM.push(agencia.MediaRAM);
                            arrayDados2024CPU.push(agencia.MediaCPU);
                        }
                    });

                    var serieData = [];
                    if (componente == "CPU") {
                        serieData = [
                            { name: "2023", data: arrayDados2023CPU },
                            { name: "2024", data: arrayDados2024CPU }
                        ];
                    } else if (componente == "RAM") {
                        serieData = [
                            { name: "2023", data: arrayDados2023RAM },
                            { name: "2024", data: arrayDados2024RAM }
                        ];
                    }

                    if (chart2) {
                        chart2.destroy();
                    }

                    var options2 = {
                        chart: {
                            type: "bar",
                        },
                        series: serieData,
                        xaxis: {
                            categories: ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
                        },
                        legend: {
                            position: 'top',
                        },
                        dataLabels: {
                            enabled: false
                        },
                        yaxis: {
                            labels: {
                                formatter: function (val) {
                                    return val + "%";
                                }
                            }
                        },
                        colors: [
                            "#247497",
                            "#0f1023"
                        ],
                        title: {
                            text: `Média de ${componente} por mês da Agência ${agencias2}`,
                            style: {
                                fontSize: '20px',
                                fontWeight: 'normal',
                                fontFamily: "Poppins",
                                color: '#000',
                            },
                            align: 'center',
                            marginTop: 10,
                            marginBottom: 10,
                            paddingTop: 10,
                        }
                    };

                    chart2 = new ApexCharts(document.querySelector("#chart2"), options2); 
                    chart2.render();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    //KPI 1
    function buscarAgencia() {
        var maisAlertas = document.getElementById("maior_alerta");
        var menosAlertas = document.getElementById("menos_alerta");
        var selectAgencia = document.getElementById("select_agencia");

        var cepMaisAlertas = document.getElementById("cep_mais_alertas");
        var cepMenosAlertas = document.getElementById("cep_menos_alertas");

        var numeroMaisAlertas = document.getElementById("numero_mais_alertas");
        var numeroMenosAlertas = document.getElementById("numero_menos_alertas");

        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    cepMaisAlertas.innerHTML = `${agenciaMaisAlertas.cep}`;
                    numeroMaisAlertas.innerHTML = `${agenciaMaisAlertas.numero}`;

                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;
                    cepMenosAlertas.innerHTML = `${agenciaMenosAlertas.cep}`;
                    numeroMenosAlertas.innerHTML = `${agenciaMenosAlertas.numero}`;

                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function buscarAgenciaSelecionada() {
        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;

        var selectAno = document.getElementById("select_ano");
        var anos = select_ano.value;

        fetch(`/agencia/buscarAgencia/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    const opcaoExistente = document.querySelector(`#select_agencia option[value="${agenciaMaisAlertas.fkAgencia}"]`);
                    if (opcaoExistente) {
                        opcaoExistente.selected = true;
                        opcaoExistente.disabled = true;
                    } else {
                        const option = document.createElement("option");
                        option.value = agenciaMaisAlertas.fkAgencia;
                        option.text = `Agência ${agenciaMaisAlertas.fkAgencia}`;
                        option.selected = true;
                        option.disabled = true;
                        selectAgencia.appendChild(option);
                    }
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }

                dadosGrafico();
                dadosGrafico2();
                VisuAlertaHorario();

            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    // SELECT DA TELA
    function selecionarAgencia() {
        fetch(`/agencia/listar`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dados) => {

                    dados.agencias.forEach((agencia) => {
                        if (!document.querySelector(`#select_agencia option[value="${agencia.idAgencia}"]`)) {
                            select_agencia.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                            select_agencia2.innerHTML += `<option value="${agencia.idAgencia}">Agência ${agencia.idAgencia}</option>`;
                        }
                    });


                    dados.anos.forEach((ano) => {
                        if (!document.querySelector(`#select_ano option[value="${ano.anoAtual}"]`)) {
                            select_ano.innerHTML += `<option value="${ano.anoAtual}">${ano.anoAtual}</option>`;
                        }
                    });

                    buscarAgenciaSelecionada();
                    buscarAgencia();
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    var agencias = select_agencia.value;

    //KPI 2
    function VisuAlertaHorario() {

        var select_agencia = document.getElementById("select_agencia")
        var agencias = select_agencia.value;
        var select_ano = document.getElementById("select_ano");
        var anos = select_ano.value;

        var qtd_manha = document.getElementById("qtd_manha");
        var qtd_tarde = document.getElementById("qtd_tarde");
        var qtd_noite = document.getElementById("qtd_noite");

        // COLOCAR O RESULTADO NA KPI
        fetch(`/agencia/alertaHorario/${agencias}/${anos}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((agencia) => {
                    agencia.forEach((agencia) => {

                        if (agencia.manha == 1) {
                            qtd_manha.innerHTML = `${agencia.manha} alerta`
                        } else if (agencia.manha == 0) {
                            qtd_manha.innerHTML = `0 alertas`
                        } else {
                            qtd_manha.innerHTML = `${agencia.manha} alertas`
                        }

                        if (agencia.tarde == 1) {
                            qtd_tarde.innerHTML = `${agencia.tarde} alerta`
                        } else if (agencia.tarde == 0) {
                            qtd_tarde.innerHTML = `0 alertas`
                        } else {
                            qtd_tarde.innerHTML = `${agencia.tarde} alertas`
                        }

                        if (agencia.noite == 1) {
                            qtd_noite.innerHTML = `${agencia.noite} alerta`
                        } else if (agencia.noite == 0) {
                            qtd_noite.innerHTML = `0 alertas`
                        } else {
                            qtd_noite.innerHTML = `${agencia.noite} alertas`
                        }

                        var allOptions = select_agencia.querySelectorAll('option');
                        allOptions.forEach(option => {
                            if (option.value === agencias) {
                                option.disabled = true;
                            } else {
                                option.disabled = false;
                            }
                        });

                    });
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    setInterval(buscarAgencia, 5000);

    function agenciaSelecionadaAtual() {

        //var maquina = select_maquina.value; ainda não
        var agencia = select_agencia.value;

        fetch("/agencia/buscarAgencia", {
            method: "GET",
        })
            .then(function (resposta) {
                return resposta.json();
            })
            .then((agencias) => {
                if (agencias.length > 0) {

                    const agenciaMaisAlertas = agencias[0];
                    const agenciaMenosAlertas = agencias[agencias.length - 1];

                    maisAlertas.innerHTML = `${agenciaMaisAlertas.fkAgencia} (${agenciaMaisAlertas.totalAlertas} alertas)`;
                    menosAlertas.innerHTML = `${agenciaMenosAlertas.fkAgencia} (${agenciaMenosAlertas.totalAlertas} alertas)`;
                } else {
                    maisAlertas.innerHTML = "0";
                    menosAlertas.innerHTML = "0";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

    }


</script>