<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vault Wise - Crie sua conta</title>
  <link rel="stylesheet" href="css/styleCadastroFuncionario.css">
  <link rel="shortcut icon" type="imagex/png" href="css/imagens/logosemfundo.png">
</head>

<body onload="selecionarEmpresa()">
  <header>
    <div class="logo"><img src="css/imagens/logosemfundo.png" alt=""></div>
    <div class="logo">VaultWise</div>
    <nav>
      <ul id="link_nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="index.html#sobre_nos">Sobre</a></li>
        <li class="btn_login"><a href="Login.html">Login</a></li>
      </ul>
    </nav>
    <button class="hamburguer" onclick="ativarMenu()">&#9776;</button>
  </header>
  <div class="container">
    <div class="form-container" id="telaCadastro">
      <h1>Olá! Seja bem-vindo!</h1>
      <h2>Crie sua conta<span style="color: #012e5c;">.</span></h2>
      <p>Já possui conta?<a href="#"><span style="color: #81aad2  ;"> Login</span></a></p>
      <form>
        <div class="inputs1">
          <input type="text" placeholder="Nome" class="input_nome" id="input_nome">
          <input type="text" placeholder="CPF" class="input_cpf" id="input_cpf">
        </div>
        <div class="inputs2">
          <input type="text" placeholder="Email" class="input_email" id="input_email">
          <input type="text" placeholder="Telefone" class="input_tel" id="input_telefone">
        </div>
        <div class="inputs3">
          <select type="text" placeholder="Cargo" id="select_cargo">
            <option disabled selected> Selecione seu cargo: </option>
            <option value="Supervisora Técnica"> Supervisora Técnica</option>
            <option value="Analista de Dados"> Analista de Dados</option>
            <option value="Chefe de Ciber Segurança"> Chefe de Ciber Segurança</option>
          </select>
        </div>
        <div class="inputs4">
          <select type="text" id="select_empresa">
            <option disabled selected> Selecione uma Empresa: </option>
          </select>
          <input type="password" placeholder="Senha" class="input_senha" id="input_senha">
        </div>
        <div class="buttons">
          <button onclick="autenticar()" type="submit" class="btn-primary">Validar Conta</button>
        </div>
        <div id="div_erro">
        </div>
      </form>
    </div>
    <div id="telaCodigo">
      <form>
        <div class="codigoAutenticacao">
          <input type="text" id="input_codigo">
          <button onclick="cadastrar()">Cadastrar</button>
        </div>
      </form>
    </div>
  </div>
</body>

</html>

<script>
  telaCodigo.style.display = "none"
  var codigoEmpresaVar;
  var nome;
  var cpf;
  var email;
  var telefone;
  var cargo;
  var idEmpresa;
  var senha;

  function ativarMenu() {
    var linknav = document.getElementById("link_nav")
    linknav.classList.toggle("ativo")
  }

  function mudarCadastro() {
    window.location.href = "CadastroEmpresa.html"
  }

  function autenticar() {
    event.preventDefault();
    nome = input_nome.value;
    cpf = input_cpf.value;
    email = input_email.value;
    telefone = input_telefone.value;
    cargo = select_cargo.value;
    idEmpresa = select_empresa.value;
    senha = input_senha.value;

    var tamNome = nome.length;
    var tamTelefone = telefone.length;
    var arrobas = email.indexOf('@');
    var ponto = email.indexOf('.');
    var tamCPF = cpf.length;
    var tamSenha = senha.length;
    var hashtag = senha.indexOf('#');
    var arrobaSenha = senha.indexOf('@');
    var underline = senha.indexOf('_');
    var cifroes = senha.indexOf('$');
    var porcentagens = senha.indexOf('%');
    // var confirmacaoSenha = confirmarSenha_input.value;
    // var verificarSenha = confirmacaoSenha;
    
    if (nome == '' ||
      cpf == '' ||
      email == '' ||
      senha == '') {
      div_erro.innerHTML = '<u>Atenção!</u> Todos os campos precisam ser preenchidos para a conclusão do cadastro!';
    } else if (tamNome <= 1) {
      div_erro.innerHTML = 'O nome inserido é inválido.';
    } else if (tamCPF != 11) {
      div_erro.innerHTML = 'O CPF ou inserido deve ser válido para a conclusão do cadastro.'
    } else if (arrobas < 0 || ponto < 0) {
      div_erro.innerHTML = 'O e-mail inserido deve ser válido para a conclusão do cadastro.';
    } else if (tamTelefone != 11) {
      div_erro.innerHTML = 'Telefone inválido';
    } else if (cargoVar == "0") {
      div_erro.innerHTML = 'Selecione um cargo';
    } else if (tamCodigo < 1) {
      div_erro.innerHTML = 'Código inválido';
    } else if (tamSenha < 8) {
      div_erro.innerHTML = 'A senha deve possuir ao menos 8 caracteres.';
    } else if (hashtag < 0 && arrobaSenha < 0 && underline < 0 && cifroes < 0 && porcentagem < 0) {
      div_erro.innerHTML = 'Por segurança, a senha deve possuir ao menos um caractere especial!';
    } else if (senhaVar != verificarSenha) {
      div_erro.innerHTML = 'A verificação da senha falhou.';
    } else {
      telaCadastro.style.display = "none"
      telaCodigo.style.display = "block"
     
      capturarCodigo(idEmpresa);
    }
  }

  function selecionarEmpresa() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            select_empresa.innerHTML += `<option value="${empresa.idEmpresa}">${empresa.razaoSocial}</option>`
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

  }

  function cadastrar() {
    var codigoDigitado = input_codigo.value;

    if (codigoEmpresaVar == codigoDigitado) {
      fetch("/usuarios/cadastrar", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          nomeServer: nome,
          cpfServer: cpf,
          emailServer: email,
          telefoneServer: telefone,
          cargoServer: cargo,
          senhaServer: senha,
          idEmpresaServer: idEmpresa
        }),
      })
        .then(function (resposta) {
          console.log("resposta: ", resposta);

          if (resposta.ok) {
            // cardErro.style.display = "block";

            // mensagem_erro.innerHTML =
            //   "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

            // setTimeout(() => {
            //   window.location = "login.html";
            // }, "2000");

            // limparFormulario();
            // finalizarAguardar();

            alert("Usuário Cadastrado")
          } else {
            throw "Houve um erro ao tentar realizar o cadastro!";
          }
        })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
          // finalizarAguardar();
        });
    } else {
      alert('Código incorreto')
    }
  }

  function capturarCodigo(idEmpresa) {
    fetch(`/empresas/buscarCodigo/${idEmpresa}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((codigo) => {
          codigoEmpresaVar = codigo[0].codigoEmpresa
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }
</script>